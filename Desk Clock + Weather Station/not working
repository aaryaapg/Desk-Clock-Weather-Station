#include <Time.h>
#include <TimeLib.h>
#include <ESP8266WiFi.h>
#include <NTPClient.h>
#include <WiFiUdp.h>
#include <Adafruit_PCD8544.h>
#include <Adafruit_GFX.h>
#include <gfxfont.h>
#include <SPI.h>
#include <DHT.h>        // DHT11 temperature and humidity sensor Library

# define DHTPIN D5      // DHTPIN : I have connected DHT11 Sensor to pin D5 (ie, GPIO0 of ESP8266
# define DHTTYPE DHT11  // We are using DHT11. (Can use DHT22.. or any other from this series

const char *ssid     = "";
const char *password = "";
int GMT = 5;
int DAY, MONTH, YEAR, Seconds, Hours;
long int time_now;
WiFiUDP ntpUDP;
NTPClient timeClient(ntpUDP);

Adafruit_PCD8544 display = Adafruit_PCD8544(D4, D3, D2, D1, D0); // Nokia 5110 LCD module connections (CLK, DIN, D/C, CS, RST)
DHT dht = DHT(DHTPIN, DHTTYPE);   // DHT dht = DHT(DHTPIN,Sensor_type), "dht" is the name of the sensor (variable)

void setup(void)
{ 
  WiFi.begin(ssid, password);
  while ( WiFi.status() != WL_CONNECTED ) 
  {
    delay ( 500 );
    Serial.print ( "." );
  }
  timeClient.begin();
  
  display.begin(); // initialize the display
  display.setContrast(50); // You can change the contrast around to adapt the display
  display.clearDisplay();  /* Clear the screen and buffer so that garbage value isnt't printed on the sceen when it starts */
  //display.drawFastHLine(0, 20, display.width(), BLACK); // Draw Horizontal line
  display.setTextSize(1); // Size can be 1 or 2 or 3 etc
  display.setTextColor(BLACK, WHITE); // To Display inverted text: display.setTextColor(WHITE, BLACK);
  display.setCursor(0, 0); //(6, 0)
  display.print("TEMP.:");
  display.setCursor(0, 10); //(15, 28)
  display.print("HUMI.:");
  display.display();
  
  dht.begin();          //Initialize the sensor
  Serial.begin(9600);   //Begin serial communication at a baud rate of 9600
  Serial.println("Humidity and temperature\n\n");
  delay(100);
}
void loop() {
    timeClient.update();
    time_now = timeClient.getEpochTime() + (GMT * 3600);                            //get epoch time and adjust it according to your GMT
    DAY = day(time_now);
    MONTH = month(time_now);
    YEAR = year(time_now);
    Hours = hourFormat12(time_now);
    Seconds = second(time_now);
    LCD_DISPLAY(String(DAY), String(MONTH), String(YEAR));
    display.display();
    delay(1000);

    
    int h = dht.readHumidity();
    int tc = dht.readTemperature();   
    float tf = dht.readTemperature(true);   // Get Temperature in F   
    float hif = dht.computeHeatIndex(tf, h); // Heat index in F, Default
    float hic = dht.computeHeatIndex(tc, h, false);  // Heat index in C
    Serial.print("Humidity = ");
    Serial.print(h);
    Serial.print("% |");
    Serial.print("Temperature = ");
    Serial.print(tc); 
    Serial.print("\xC2\xB0 C ie, ");    // Serial.print(" \xC2\xB0"); is used to print the degree symbol in the serial monitor
    Serial.print(tf);
    Serial.print("\xC2\xB0 F |");
    Serial.print("Heat index = ");
    Serial.print(hic); 
    Serial.print("\xC2\xB0 C ie, ");
    Serial.print(hif);
    Serial.println("\xC2\xB0 F |");

    // To print temperature (in °C)
    display.setCursor(35, 0); //(18,12);
    display.printf(" %02u.%1u C", (tc)%100, tc % 10); // print degree symbol ( ° ): %02u.%1u C
 
    // To print humidity (in %)
    display.setCursor(40, 10); //(24, 40);
    display.printf("%02u.%1u %%", (h)%100, h % 10); // print degree symbol ( % ): %02u.%1u %%
 
    display.display(); // To update the display
    delay(2000); // Delay of 2 seconds between readings
}

void LCD_DISPLAY(String DAY, String MONTH, String YEAR)
{
  display.clearDisplay();
  display.setTextSize(2);
  display.setTextColor(BLACK);
  display.setCursor(0, 20); //(0, 5)
  if (Hours > 9)
    display.println(String(Hours) + ":" + timeClient.getMinutes());
  if (Hours < 10)
    display.println("0" + String(Hours) + ":" + timeClient.getMinutes());

  display.setTextSize(1);
  display.setTextColor(BLACK);
  display.setCursor(65, 20);  //(65, 5)
  display.println(String(Seconds));

  display.setTextSize(1);
  display.setTextColor(BLACK);
  display.setCursor(65, 29); //(65, 14);
  if (isPM(time_now))
    display.println("PM");
  if (isAM(time_now))
    display.println("AM");
  display.setTextSize(1);
  display.setTextColor(BLACK);
  display.setCursor(15, 50); //(15, 35)
  display.println(DAY + ":" + MONTH + ":" + YEAR);

}
